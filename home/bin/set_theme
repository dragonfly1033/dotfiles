#!/bin/sh

theme=$1

if [ -z $theme ]; then
	theme=$(cat $HOME/bin/.env/THEME)
else
	echo $theme > $HOME/bin/.env/THEME
fi

path="${HOME}/.config/themes/${theme}"
sed_var=${HOME}/bin/sed_var

newaccent=$(awk '{print $1}' "${path}")
newaccent2=$(awk '{print $2}' "${path}")
newback=$(awk '{print $3}' "${path}")
newtext=$(awk '{print $4}' "${path}")
newtextd=$(awk '{print $5}' "${path}")

$sed_var "theme.border_focus = " "\"#$newaccent\"" $HOME/.config/awesome/theme.lua
$sed_var "theme.border_normal = " "\"#$newback\"" $HOME/.config/awesome/theme.lua
$sed_var "theme.hotkeys_bg = " "\"#$newback\"" $HOME/.config/awesome/theme.lua
$sed_var "theme.bg_urgent = " "\"#$newback\"" $HOME/.config/awesome/theme.lua
$sed_var "theme.hotkeys_modifiers_fg = " "\"#$newtext\"" $HOME/.config/awesome/theme.lua
$sed_var "theme.hotkeys_fg = " "\"#$newtext\"" $HOME/.config/awesome/theme.lua

$sed_var "background-alt = " "#$newaccent2" $HOME/.config/polybar/config.ini
$sed_var "primary = " "#$newaccent" $HOME/.config/polybar/config.ini
$sed_var "background = " "#$newback" $HOME/.config/polybar/config.ini
$sed_var "foreground = " "#$newtext" $HOME/.config/polybar/config.ini
$sed_var "disabled = " "#$newtextd" $HOME/.config/polybar/config.ini
$sed_var "secondary = " "#$newaccent2" $HOME/.config/polybar/config.ini

$sed_var "accent: " "#$newaccent;" $HOME/.config/rofi/theme.rasi
$sed_var "background-color: " "#$newback;" $HOME/.config/rofi/theme.rasi
$sed_var "text-color: " "#$newtext;" $HOME/.config/rofi/theme.rasi

for i in $(ls -1d $HOME/.mozilla/firefox/*/ | sed '/firefox\/.*\..*\/$/ !d'); do
	$sed_var "  --my-accent: " "#$newaccent;" "$i""chrome/resources/userChrome.css"
	$sed_var "  --my-foreground: " "#$newtext;" "$i""chrome/resources/userChrome.css"
	$sed_var "  --my-background: " "#$newback;" "$i""chrome/resources/userChrome.css"
done

$sed_var "name=" "\"$theme\"" $HOME/.fehbg

sed -r "s/(background: '0x)(.*)(')/\1$newback\3/" -i $HOME/.config/alacritty/themes/theme.yaml
sed -r "s/(foreground: '0x)(.*)(')/\1$newtext\3/" -i $HOME/.config/alacritty/themes/theme.yaml

noUse=$2

if [[ "_$noUse" == "_" ]]; then
	for i in $(xwininfo -tree -root | grep 'Navigator' | tr -d ' ' | cut -d'"' -f1); do
		xdotool key --window "$i" --clearmodifiers "ctrl+h" &
	done

	$HOME/bin/awesome_restart
fi
